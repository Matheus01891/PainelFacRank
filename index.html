<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Valley Farm | Admin</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        valley: { 500: '#ec4899', 600: '#db2777', 900: '#831843', dark: '#0f0f10' }
                    },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #09090b; color: #e4e4e7; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(20, 20, 22, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(236, 72, 153, 0.1); }
        .glass-header { background: rgba(15, 15, 16, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(236, 72, 153, 0.15); }
        .bot-toggle { transition: all 0.3s ease; }
        .bot-active { background-color: #5865F2; color: white; box-shadow: 0 0 15px rgba(88, 101, 242, 0.4); }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #ec4899; }
        /* Modal Overlay */
        .modal-overlay { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // =================================================================================
        // âš™ï¸ CONFIGURAÃ‡ÃƒO
        // =================================================================================
        
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyAqYDbEuyycnx-wIb0SnRnF_oFIT8ebBd0",
                authDomain: "dados-do-farm.firebaseapp.com",
                projectId: "dados-do-farm",
                appId: "1:562865269160:web:5398b6d0da1bfb0151159d"
            },
            senhaAdmin: "valley123", 
            webhookUrl: "https://discord.com/api/webhooks/1442736005110038608/SI9XTxc6nL-Z7Yj177QGvWw8Q80xsptxoq70HhdPhTFEZJjJGcvzOcTXzCH41RixLAYd" 
        };

        const Icons = {
            Lock: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>,
            Unlock: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>,
            Shield: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>,
            Sword: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"></polyline><line x1="13" y1="19" x2="19" y2="13"></line><line x1="16" y1="16" x2="20" y2="20"></line><line x1="19" y1="21" x2="21" y2="19"></line></svg>,
            Copy: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
            Trash: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Upload: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
            Search: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            Edit: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            History: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
            Discord: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037 14.168 14.168 0 0 0-.64 1.307 18.277 18.277 0 0 0-5.428 0 14.28 14.28 0 0 0-.644-1.309.071.071 0 0 0-.077-.036 19.736 19.736 0 0 0-4.89 1.515.06.06 0 0 0-.027.027C1.487 9.525.79 14.544 1.706 19.508a.077.077 0 0 0 .03.057 19.9 19.9 0 0 0 6.014 3.018.076.076 0 0 0 .083-.026 14.17 14.17 0 0 0 1.258-2.036.077.077 0 0 0-.041-.107 13.048 13.048 0 0 1-1.898-.905.078.078 0 0 1-.005-.129c.126-.094.25-.192.37-.294a.075.075 0 0 1 .078-.01c3.928 1.793 8.18 1.793 12.067 0a.074.074 0 0 1 .08.01c.118.1.242.198.368.293a.077.077 0 0 1-.005.13 12.592 12.592 0 0 1-1.898.904.076.076 0 0 0-.04.107 14.284 14.284 0 0 0 1.256 2.035.076.076 0 0 0 .084.027 19.866 19.866 0 0 0 6.02-3.02.077.077 0 0 0 .03-.056c.806-4.38.16-9.224-1.95-14.293a.06.06 0 0 0-.028-.027zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.418 2.157-2.418 1.21 0 2.176 1.095 2.157 2.418 0 1.334-.956 2.42-2.157 2.42zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.418 2.157-2.418 1.21 0 2.176 1.095 2.157 2.418 0 1.334-.946 2.42-2.157 2.42z"/></svg>
        };

        const formatNumber = (num) => num ? num.toLocaleString('pt-BR') : '0';
        
        const formatDate = (timestamp) => {
            if (!timestamp) return '...';
            const d = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [isAdmin, setIsAdmin] = useState(false);
            const [members, setMembers] = useState([]);
            const [history, setHistory] = useState([]);
            const [status, setStatus] = useState('Conectando...');
            const [fb, setFb] = useState(null);
            const [rawLog, setRawLog] = useState("");
            const [loading, setLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const [activeTab, setActiveTab] = useState('ranking');
            const [autoDiscord, setAutoDiscord] = useState(true);
            const [editingMember, setEditingMember] = useState(null);

            // InicializaÃ§Ã£o
            useEffect(() => {
                const init = async () => {
                    let firebaseConfig = CONFIG.firebase;
                    try {
                        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                        const db = firebase.firestore();
                        const auth = firebase.auth();
                        await auth.signInAnonymously();
                        
                        setFb({ db, auth, batch: () => db.batch(), increment: (n) => firebase.firestore.FieldValue.increment(n), serverTimestamp: () => firebase.firestore.FieldValue.serverTimestamp() });
                        
                        // Listener de Membros
                        db.collection('valley_members').onSnapshot(snap => {
                            setMembers(snap.docs.map(d => ({id: d.id, ...d.data()})));
                            setStatus('Online');
                        }, err => {
                            console.error(err);
                            setStatus('Erro PermissÃ£o');
                        });
                        
                    } catch (e) { setStatus('Erro ConexÃ£o'); }
                };
                init();
            }, []);

            // Listener de HistÃ³rico (SÃ³ ativa se estiver na aba histÃ³rico para economizar)
            useEffect(() => {
                if (!fb || activeTab !== 'history') return;
                
                const unsub = fb.db.collection('valley_history')
                    .orderBy('timestamp', 'desc')
                    .limit(50) // Pega os Ãºltimos 50 eventos
                    .onSnapshot(snap => {
                        setHistory(snap.docs.map(d => ({id: d.id, ...d.data()})));
                    });
                    
                return () => unsub();
            }, [fb, activeTab]);

            // FunÃ§Ã£o Auxiliar de Log
            const addToHistory = async (type, details) => {
                if (!fb) return;
                try {
                    await fb.db.collection('valley_history').add({
                        type: type,
                        details: details,
                        timestamp: fb.serverTimestamp(),
                        author: isAdmin ? 'Admin' : 'Sistema'
                    });
                } catch (e) { console.error("Erro ao salvar histÃ³rico", e); }
            };

            const handleLogin = () => {
                if (isAdmin) { setIsAdmin(false); return; }
                const pass = prompt("Digite a senha de ADMINISTRADOR da facÃ§Ã£o:");
                if (pass === CONFIG.senhaAdmin) { setIsAdmin(true); alert("Modo ADMIN ativado!"); } 
                else { alert("Senha incorreta."); }
            };

            const testWebhook = async () => {
                if (!CONFIG.webhookUrl) return alert("ERRO: Link do Webhook invÃ¡lido!");
                try {
                    await fetch(CONFIG.webhookUrl, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ content: "âœ… **Teste do Bot Valley!** O sistema estÃ¡ conectado." }) });
                    alert("Mensagem enviada!");
                } catch (e) { alert("Erro ao enviar."); }
            };

            const sendWebhook = async (actionType) => {
                if (!CONFIG.webhookUrl || !autoDiscord) return;
                const topMembers = [...members].sort((a,b) => (b.amount||0) - (a.amount||0)).slice(0, 10);
                const totalFarm = members.reduce((a,c) => a + (c.amount||0), 0);
                const date = new Date().toLocaleTimeString('pt-BR');

                let rankingString = topMembers.length > 0 ? topMembers.map((m, i) => {
                    const medal = i===0 ? 'ðŸ¥‡' : i===1 ? 'ðŸ¥ˆ' : i===2 ? 'ðŸ¥‰' : `#${i+1}`;
                    return `**${medal}** \`${m.name}\` â€” **${
